<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<html>
  <head>
    <title>台灣用電來源結構分析統計</title>
    <meta charset="utf-8" />
    <link href="css/semantic.min.css" rel="stylesheet" type="text/css"/>
    <link href="css/index.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Noto+Sans:400,700" rel="stylesheet" type="text/css">
    <meta property="og:title" content="台灣用電來源結構分析統計">
    <meta property="og:site_name" content="台灣用電來源結構分析統計">
    <meta property="og:description" content="台灣用電來源結構分析統計">
    <meta property="og:image" content="http://i.imgur.com/04AFcnA.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="300">
    <meta property="og:image:height" content="300">
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="all" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/favicon.ico" />

  </head>
  <body>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/semantic.min.js" type="text/javascript"></script> 
    <script src="js/d3.min.js" type="text/javascript"></script>
    <script src="js/visual.js" type="text/javascript"></script> 

    <div class="ui basic main segment">
      <div class="ui head basic segment">
        <h1 class="ui header">台灣用電來源結構分析統計</h1>
      </div>

      <h3>相關連結：</h3>

        <a href="http://real.taiwanstat.com/power">
            <div class="ui basic button">台灣即時用電資訊</div>
        </a>
      <hr>

      <div class="ui stackable two column grid">
        <div class="column">
          <div class="fb-like-box" data-href="https://www.facebook.com/taiwanstat?fref=ts" data-colorscheme="light" data-show-faces="false" data-header="false" data-stream="false" data-show-border="false"></div>
        </div>
        <div class="column">
          <div class="fb-like" data-href="http://long.taiwanstat.com/energy/" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
        </div>
      </div>

      <br>

      <div class="ui head basic segment">
        <h2 class="ui header">時間</h2>
      </div>

      <div class="control panels">
        <div class="year control panel">
          <div class="ui compact icon year control left button">
            <i class="year caret left icon"></i>
          </div>

          <div class="ui horizontal year control statistic">
            <div class="value"></div>
            <div class="label">年</div>
          </div>

          <div class="ui compact icon year right control button">
            <i class="year caret right icon"></i>
          </div>
        </div>
      </div>

      <div class="ui segment">
        <div class="ui stackable grid">

          <div class="ten wide column">
            <div class="plot"></div>
            <div class="note">
              <ul>
                <li class="data-src">資料來源：<a href="http://web3.moeaboe.gov.tw/">經濟部能源局</a></li>
                <li>此圖以互動式的方式呈現台灣各種發電量的原始值及所佔比例。</li>
                <li>使用者可自行調整時間及選擇各項目詳細觀察之。</li>
                <li>各項目詳細採用原始資料之結構，例如是否為台電生產、發電方式。</li>
                <li>能源局提供之資料為1998至2013。</li>
              </ul>
            </div>
          </div>

          <div class="six wide column">

            <div class="ui basic curSelect segment">
              <div class="ui breadcrumb">
                <div class="active section">全部</div>
                <i class="right chevron icon divider"></i>
              </div>

              <h1 class="ui curSelect header"></h1>

              <div class="ui curSelect small statistics">
                <div class="statistic">
                  <div class="raw value"></div>
                  <div class="left label">
                    百萬度
                  </div>
                </div>
                <div class="statistic">
                  <div class="percent value"></div>
                  <div class="left label">
                    所佔百分率(%)
                  </div>
                </div>

              </div>
              <div class="ui curSelect teal button">詳細</div>
              <br><br><br>
              <h3 class="ui red header" style="font-weight:bold;">*點擊圓餅圖來顯示其他部分</h3>
            </div>

            <h2 class="ui header">合計</h2>

            <div class="ui horizontal total small statistic">
              <div class="value"></div>
              <div class="label">
                百萬度
              </div>
            </div>

            <table class="ui table">
              <thead>
                <tr>
                  <th>項目</th>
                  <th>原始值</th>
                  <th>比例</th>
                </tr>
              </thead>
              <tbody class="piechart tbody">
              </tbody>
            </table>

          </div>

        </div>
      </div>

    </div>

    <script>

    var highlight = 0;
    var curYearIndex;
    var curItem;
    var parentStack = [];
    var parentNameStack = [];
    var years = [];

    d3.csv("data/data.csv", function(data) {

      for(var k in Object.keys(data[0])){
        var y = parseInt(Object.keys(data[0])[k]);
        if(!isNaN(y))
          years.push(y)
      }

      curYearIndex = years.length-1;

      curItem = preProcess(data);

      buttonInit();

      updateTable();

      piechart(curItem, years[curYearIndex]);

    });

    function buttonInit() {
      $('.year.control .value').html('<i class="small calendar outline icon"></i>' + years[curYearIndex])

      $('.year.left.button').on('click', function(){
        if(curYearIndex == 0)
          curYearIndex = years.length-1;
        else
          curYearIndex = curYearIndex - 1;
        $('.year.control .value').html('<i class="small calendar outline icon"></i>' + years[curYearIndex])
        updateTable();
        updatePie(curItem, years[curYearIndex]);
      })
      $('.year.right.button').on('click', function(){
        if(curYearIndex == years.length-1)
          curYearIndex = 0;
        else
          curYearIndex = curYearIndex + 1;
        $('.year.control .value').html('<i class="small calendar outline icon"></i>' + years[curYearIndex])
        updateTable();
        updatePie(curItem, years[curYearIndex]);
      })

      $('.curSelect.button').on('click', function() {
        if(curItem[highlight].children != undefined) {
          parentStack.push(curItem);
          parentNameStack.push(curItem[highlight].name);
          curItem = curItem[highlight].children;
          highlight = 0;
          updateTable();
          updatePie(curItem, years[curYearIndex]);
        }

        if(curItem[highlight].children == undefined)
          $(this).addClass('disabled');
        else if(curItem[highlight][years[curYearIndex]] == 0)
          $(this).addClass('disabled');
        else
          $(this).removeClass('disabled');

        updateBreadcrumb();
      })
    }

    function updateBreadcrumb() {
      var html = ''
      if(parentNameStack.length == 0){
        html = '<div class="active section">全部</div><i class="right chevron icon divider"></i>';
        $('.breadcrumb').html(html);
      }
      else {
        html = '<a class="section" onclick="toBreadcrumb('+0+')">全部</a><i class="right chevron icon divider"></i>'
        for(var i=0; i<parentNameStack.length; i++) {
          // console.log(parentStack[i]);
          if(i != parentNameStack.length-1){
            html = html + '<a class="section" onclick="toBreadcrumb('+(i+1)+')">' +
              parentNameStack[i] + '</a><i class="right chevron icon divider"></i>';
          }
          else{
            html += '<div class="active section" onclick="toBreadcrumb('+(i+1)+'")>' +
              parentNameStack[i] + '</div><i class="right chevron icon divider"></i>';
          }
        }
        $('.breadcrumb').html(html);
      }
    }

    function updateTable() {
      var total = 0;
      var validCount = 0;
      var y = years[curYearIndex];

      for(var k in curItem){
        var o = curItem[k];
        var value = o[y];

        if(typeof(value) == 'string')
          value = value.replace(',','');

        if(!isNaN(parseFloat(value))){
          value = parseFloat(value);
          curItem[k][y] = value;
          total += value;
          validCount += 1;
        }
        else {
          value = 0;
          curItem[k][y] = value;
        }
      }

      if(highlight > validCount-1)
        hightlight = 0;

      $('.total.statistic .value').text(Math.round(total*100)/100);

      var html = ''
      for(var k in curItem){
        var value = curItem[k][y];
        var mean = value;

        if(!isNaN(value)){
          mean = curItem[k][y]/total;
          mean = Math.round(mean*10000)/100;
        }

        if(isNaN(mean))
          mean = 0;

        var ihtml =
          '<tr><td><div class="ui header name tno'+k+'">'+curItem[k]['name']+'</div></td>' +
          '<td><div class="ui mini statistic">'+
            '<div class="value">'+value+'</div>'+
            '<div class="left label">百萬度</div></div></td>'+
          '<td><div class="ui mini horizontal statistic">'+
            '<div class="mean tno'+k+' value">'+mean+'</div>'+
            '<div class="label">%</div></div></td></tr>';

        html += ihtml;
      }

      if( screen.width <= 480 ) {
        html = html.replace(/mini statistic/g, 'mini horizontal statistic');
        html = html.replace(/left label/g, 'label');
      }
      // console.log(html);

      if(curItem[highlight].children == undefined)
        $('.curSelect.button').addClass('disabled');
      else if(curItem[highlight][y] == 0)
        $('.curSelect.button').addClass('disabled');
      else
        $('.curSelect.button').removeClass('disabled');

      $('.piechart.tbody').html(html);

    }

    function preProcess(data) {
      for(var i=0; i<data.length; i++){
        var d = data[i];
        for(var j=1; j<5; j++){
          if(d['level'+j] != '')
            d.level = j
        }
        d.name = d['level'+d.level];
      }

      var i = 0;
      var level = 4;

      while(level > 1){

        if(i != 0){
          if(data[i].level == level && data[i].level == data[i-1].level+1){
            if(data[i-1].children == undefined)
              data[i-1].children = []
            data[i-1].children.push(data[i]);
            data.splice(i, 1);
            i -= 1;
          }
        }

        i++;
        if(i == data.length){
          i = 0;
          level -= 1;
        }
      }

      return data;
    }

    function toBreadcrumb(i) {
      curItem = parentStack[i];
      highlight = 0;
      updateTable();
      updatePie(curItem, years[curYearIndex]);
      while(parentStack.length > i){
        parentStack.pop();
        parentNameStack.pop();
      }
      updateBreadcrumb();
    }

    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-61023469-1', 'auto');
      ga('send', 'pageview');
    </script>
    <div id="fb-root"></div>
    <script>
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/zh_TW/sdk.js#xfbml=1&appId=600079286760117&version=v2.0";
        fjs.parentNode.insertBefore(js, fjs);
      }
      (document, 'script', 'facebook-jssdk'));
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/headroom/0.7.0/headroom.min.js"></script>
    <script src="/js/main.js"></script>

  </body>
</html>
